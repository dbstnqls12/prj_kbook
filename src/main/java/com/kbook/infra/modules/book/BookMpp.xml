<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
   
<mapper namespace="com.kbook.infra.modules.book.BookMpp">

<resultMap id="resultMapObj" type="com.kbook.infra.modules.book.Book"></resultMap>

<sql id="selectCommon">
	FROM
		tradItem a
		LEFT JOIN tradAuthor b ON b.tditSeq = a.tditSeq
		LEFT JOIN infrAuthorCode c ON c.ifacSeq = b.tdatSeq
		LEFT JOIN infrPublisherCode d ON d.ifpcSeq = a.tditPublisherCd
	WHERE 1=1 	
		AND b.tdatDefaultNy = 1
		<choose>
			<when test="shTditDelNy == 1">AND tditDelNy = 1</when>
			<when test="shTditDelNy == 0">AND tditDelNy = 0</when>
		</choose>
		<choose>
			<when test="shOption == 1">AND tditTitle LIKE concat('%', #{shValue}, '%')</when>
			<when test="shOption == 2">AND c.ifacName LIKE concat('%', #{shValue}, '%')</when>
			<when test="shOption == 3">AND d.ifpcName LIKE concat('%', #{shValue}, '%')</when>
		</choose>
		<choose>
			<when test="shOptionDate == 1">AND a.tditPublishingDate BETWEEN #{shDateStart} AND #{shDateEnd} </when>
			<when test="shOptionDate == 2">AND a.regDateTime BETWEEN #{shDateStart} AND #{shDateEnd} </when>
			<when test="shOptionDate == 3">AND a.modDateTime BETWEEN #{shDateStart} AND #{shDateEnd} </when>
		</choose>
</sql>

<select id="selectList" resultMap="resultMapObj">
	SELECT
		a.tditSeq
		,a.tditTitle
		,a.tditPublisherCd
		,a.tditPublishingDate
		,a.tditPrice
		,a.tditDelNy
		,a.tditItemCate
		,b.tdatAuthorCd
	<include refid="selectCommon"/>	
	limit #{startRnumForMysql}, #{rowNumToShow}	
</select>

<select id="selectOneCount" resultType="Integer">
	SELECT
		count(*)
	<include refid="selectCommon"/>	
</select>

<select id="selectListDomesticNew" resultMap="resultMapObj">
	SELECT
		a.tditSeq
		,a.tditTitle
		,a.tditSubTitle
		,a.tditPublisherCd
		,a.tditPublishingDate
		,a.tditStateCd
		,a.tditItemCate
		,a.tditDelNy
	FROM
		tradItem a
	WHERE 1=1 	
		AND a.tditItemCate = 2
	ORDER BY a.tditPublishingDate DESC
	limit 4	
</select>
<select id="selectListAbroadNew" resultMap="resultMapObj">
	SELECT
		a.tditSeq
		,a.tditTitle
		,a.tditSubTitle
		,a.tditPublisherCd
		,a.tditPublishingDate
		,a.tditStateCd
		,a.tditItemCate
		,a.tditDelNy
	FROM
		tradItem a
	WHERE 1=1 	
		AND a.tditItemCate = 3
		ORDER BY a.tditPublishingDate DESC
	limit 4	
</select>
<select id="selectListEbookNew" resultMap="resultMapObj">
	SELECT
		a.tditSeq
		,a.tditTitle
		,a.tditSubTitle
		,a.tditPublisherCd
		,a.tditPublishingDate
		,a.tditStateCd
		,a.tditItemCate
		,a.tditDelNy
		,a.modDateTime
		,a.modDateTimeSvr
		,a.regDateTime
		,a.regDateTimeSvr
	FROM
		tradItem a
	WHERE 1=1 	
		AND a.tditItemCate = 4
	ORDER BY a.tditPublishingDate DESC
	limit 4	
</select>

<!-- selectBest -->
<select id="selectListBest" resultMap="resultMapObj">
	SELECT
		a.tditSeq
		,a.tditTitle
		,a.tditSubTitle
		,a.tditStateCd
		,a.tditItemCate
		,a.tditDelNy
		,b.tdatAuthorCd
		,b.tdatDefaultNy
	FROM
		tradItem a
		LEFT JOIN tradAuthor b ON b.tditSeq = a.tditSeq
	WHERE 1=1 	
		AND b.tdatDefaultNy = 1		
		AND a.tditSeq BETWEEN 3 AND 10
</select>

<!-- 랜덤추천 -->
<select id="selectListToday" resultMap="resultMapObj" >
	SELECT 
		a.tditSeq 
		,a.tditTitle
		,a.tditSubTitle
		,b.tdatAuthorCd
		,b.tdatDefaultNy
	FROM 
		tradItem a
		LEFT JOIN tradAuthor b ON b.tditSeq = a.tditSeq
	WHERE 1=1 	
		AND b.tdatDefaultNy = 1		
	ORDER BY RAND()
	LIMIT 1
</select>

<!-- bookInfo -->
<select id="selectOne" resultMap="resultMapObj">
	SELECT
		a.tditSeq
		,a.tditTitle
		,a.tditSubTitle
		,a.tditPublisherCd
		,a.tditPublishingDate
		,a.tditPrice
		,a.tditDiscountCd
		,a.tditDiscountRate
		,a.tditStateCd
		,a.tditItemCate
		,a.tditItemCate2
		,a.tditIsbn
		,a.tditPage
		,a.tditSize
		,a.tditWeight
		,a.tditBookDesc
		,a.tditBookDesc2
		,a.tditTableOfContents 
		,a.tditDelNy
	FROM
		tradItem a
	WHERE 1=1 	
		AND a.tditSeq = #{tditSeq}
</select>

<select id="selectListAuthor" resultMap="resultMapObj">
	SELECT
		tdatSeq
		,tdatAuthorCd
		,tdatTranslatorCd
		,tdatDefaultNy
		,tdatDelNy
		,tditSeq
	FROM tradAuthor
	WHERE 1=1
		AND tdatDelNy = 0
		AND tditSeq = #{tditSeq}	
</select>

<select id="selectListKeyword" resultMap="resultMapObj">
	SELECT
		tdkwSeq
		,tdkwKeyword
		,tditSeq
	FROM tradItemKeyword
	WHERE 1=1
		AND tditSeq = #{tditSeq}	
</select>

<select id="selectListRelatedItem" resultMap="resultMapObj">
	SELECT
		tdriSeq
		,tdriTypeCd
		,tdriTitle
		,tdriAuthorCd
		,tdriPrice
		,tdriDelNy
		,tditSeq
	FROM tradRelatedItem
	WHERE 1=1
		AND tditSeq = #{tditSeq}
		AND tdriDelNy = 0	
</select>

<update id="update">
	UPDATE tradItem SET 
		tditPrice = #{tditPrice}
		,tditDiscountCd = #{tditDiscountCd}
		,tditDiscountRate = #{tditDiscountRate}
		,tditStateCd = #{tditStateCd}
		,tditItemCate = #{tditItemCate}
		,tditItemCate2 = #{tditItemCate2}
		,tditPage = #{tditPage}
		,tditWeight = #{tditWeight}
		,tditBookDesc = #{tditBookDesc}
		,tditBookDesc2 = #{tditBookDesc2}
		,tditTableOfContents = #{tditTableOfContents}
		,modDateTime = #{modDateTime}
	WHERE 1=1
		AND tditSeq=#{tditSeq}
</update>
<update id="updateKeyword">
	UPDATE tradItemKeyword SET 
		tdkwKeyword = #{tdkwKeyword}
	WHERE 1=1
		AND tditSeq=#{tditSeq}
</update>
<insert id="updateUploaded">
	UPDATE ${tableName} SET
		type = #{type}
		,defaultNy = #{defaultNy} 
		,sort = #{sort}
		,originalName = #{originalName}
		,uuidName = #{uuidName}
		,ext = #{ext}
		,size = #{size}
		,delNy = #{delNy}
		,pseq = #{pseq}
	)WHERE 1=1
		AND tditSeq=#{tditSeq}		
</insert>


</mapper>    